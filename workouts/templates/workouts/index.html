{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row">
        <!-- Progress Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(45deg, #00CED1, #FF1493); color: white; display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="mb-0">Progress Towards Goals</h3>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addGoalModal" id="addGoalBtn">
                        <i class="fas fa-plus"></i> Add Goal
                    </button>
                </div>
                <div class="card-body">
                    <div id="goalsContainer">
                        {% if goals %}
                            {% for goal in goals %}
                                <div class="goal-item mb-4" data-goal-id="{{ goal.id }}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ goal.get_goal_type_display }}</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-custom-gradient update-goal-btn" data-goal-id="{{ goal.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-goal-btn" data-goal-id="{{ goal.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p class="card-text">Target: {{ goal.target }}</p>
                                    <div class="progress mb-3">
                                        <div class="progress-bar" 
                                            role="progressbar" 
                                            style="width: {{ goal.progress }}%; background: linear-gradient(45deg, #FFD700, #FF8C00);" 
                                            aria-valuenow="{{ goal.progress }}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                            {{ goal.progress }}%
                                        </div>
                                    </div>
                                    {% if goal.end_date %}
                                        <p class="card-text"><small class="text-muted">End Date: {{ goal.end_date|date:"M d, Y" }}</small></p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="card-text" id="noGoalsMessage">No goals set yet.</p>
                        {% endif %}
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">You can have up to 3 goals at a time.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(45deg, #FFD700, #FF8C00); color: white;">
                    <h3 class="mb-0">Quick Actions</h3>
                </div>
                <div class="card-body">
                    <a href="{% url 'workouts.log' %}" class="btn btn-custom-gradient mb-3">Log New Workout</a>
                    <a href="{% url 'workouts.history' %}" class="btn btn-custom-gradient mb-3">View History</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Workouts -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(45deg, #FF1493, #00CED1); color: white;">
                    <h3 class="mb-0">Recent Workouts</h3>
                </div>
                <div class="card-body">
                    {% if workouts %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Workout</th>
                                        <th>Duration</th>
                                        <th>Calories</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for workout in workouts %}
                                        <tr>
                                            <td>{{ workout.date|date:"M d, Y" }}</td>
                                            <td>{{ workout.name }}</td>
                                            <td>{{ workout.duration }} mins</td>
                                            <td>{{ workout.calories_burned|default:"-" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center">No workouts logged yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- AI Workout Suggestions -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background: linear-gradient(45deg, #00CED1, #FF1493); color: white;">
                    <h3 class="mb-0" style="font-weight: bold; font-size: 1.5rem;">Suggested Workouts</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Full Body Workout</h5>
                                    <p class="card-text">A 30 minute full-body workout focusing on strength and endurance.</p>
                                    <button class="btn btn-custom-gradient start-workout-btn" 
                                            data-workout-name="Full Body Workout"
                                            data-workout-description="A 30 minute full-body workout focusing on strength and endurance."
                                            data-workout-duration="30"
                                            data-workout-calories="150"
                                            data-workout-notes="">Start Workout</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Cardio Blast</h5>
                                    <p class="card-text">A 20 minute high-intensity cardio session to boost metabolism.</p>
                                    <button class="btn btn-custom-gradient start-workout-btn"
                                            data-workout-name="Cardio Blast"
                                            data-workout-description="A 20 minute high-intensity cardio session to boost metabolism."
                                            data-workout-duration="20"
                                            data-workout-calories="200"
                                            data-workout-notes="">Start Workout</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Strength Training</h5>
                                    <p class="card-text">A 40 minute strength-training session targeting major muscle groups.</p>
                                    <button class="btn btn-custom-gradient start-workout-btn"
                                            data-workout-name="Strength Training"
                                            data-workout-description="A 40 minute strength-training session targeting major muscle groups."
                                            data-workout-duration="40"
                                            data-workout-calories="130"
                                            data-workout-notes="">Start Workout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title" id="addGoalModalLabel">Add New Goals</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="goalsList">
                    <div class="goal-form mb-4 p-3 border rounded">
                        <h6 class="mb-3">Goal #1</h6>
                        <form class="goal-entry-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Goal Type</label>
                                    <select class="form-select goal-type" name="goal_type" required>
                                        <option value="weight_loss">Weight Loss</option>
                                        <option value="muscle_gain">Muscle Gain</option>
                                        <option value="endurance">Endurance</option>
                                        <option value="flexibility">Flexibility</option>
                                        <option value="general_fitness">General Fitness</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Target</label>
                                    <input type="text" class="form-control goal-target" name="target" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control goal-end-date" name="end_date">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Initial Progress (%)</label>
                                    <input type="number" class="form-control goal-progress" name="progress" min="0" max="100" value="0" required>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary mb-3" id="addAnotherGoalBtn">
                    <i class="fas fa-plus"></i> Add Another Goal
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-custom-gradient" id="saveNewGoalsBtn">Save All Goals</button>
            </div>
        </div>
    </div>
</div>

<!-- Goal Update Modal -->
<div class="modal fade" id="updateGoalModal" tabindex="-1" aria-labelledby="updateGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title" id="updateGoalModalLabel">Update Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateGoalForm">
                    <div class="mb-3">
                        <label for="goal_type" class="form-label">Goal Type</label>
                        <select class="form-select" id="goal_type" name="goal_type" required>
                            <option value="weight_loss">Weight Loss</option>
                            <option value="muscle_gain">Muscle Gain</option>
                            <option value="endurance">Endurance</option>
                            <option value="flexibility">Flexibility</option>
                            <option value="general_fitness">General Fitness</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="target" class="form-label">Target</label>
                        <input type="text" class="form-control" id="target" name="target" required>
                    </div>
                    <div class="mb-3">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date">
                    </div>
                    <div class="mb-3">
                        <label for="progress" class="form-label">Progress (%)</label>
                        <input type="number" class="form-control" id="progress" name="progress" min="0" max="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-custom-gradient" id="saveGoalBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Goal Item Template -->
<template id="goalItemTemplate">
    <div class="goal-item mb-4">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <h5 class="card-title mb-0"></h5>
                <span class="badge bg-success completed-badge d-none">Completed!</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-custom-gradient update-goal-btn">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger delete-goal-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <p class="card-text target-text"></p>
        <div class="progress mb-3">
            <div class="progress-bar" 
                role="progressbar" 
                style="width: 0%; background: linear-gradient(45deg, #FFD700, #FF8C00);" 
                aria-valuenow="0" 
                aria-valuemin="0" 
                aria-valuemax="100">
                0%
            </div>
        </div>
        <p class="card-text end-date-text"></p>
        <p class="card-text completed-date-text d-none"></p>
    </div>
</template>

<!-- Workout Confirmation Modal -->
<div class="modal fade" id="workoutConfirmationModal" tabindex="-1" aria-labelledby="workoutConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(45deg, #00CED1, #FF1493); color: white;">
                <h5 class="modal-title" id="workoutConfirmationModalLabel">Confirm Workout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to log this workout?</p>
                <div class="workout-details">
                    <p><strong>Workout:</strong> <span id="modal-workout-name"></span></p>
                    <p><strong>Duration:</strong> <span id="modal-workout-duration"></span> minutes</p>
                    <p><strong>Calories:</strong> <span id="modal-workout-calories"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-custom-gradient" id="confirmWorkoutBtn">Log Workout</button>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient {
        background: linear-gradient(45deg, #FFD700, #FF8C00, #FF1493, #00CED1);
        background-size: 200%;
    }
    
    .card {
        border: none;
        border-radius: 15px;
        transition: transform 0.2s;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .progress {
        height: 25px;
        border-radius: 12px;
    }
    
    .progress-bar {
        border-radius: 12px;
        transition: width 0.4s ease;
    }
    
    .completed-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        margin-left: 0.5rem;
    }
    
    .goal-item.completed {
        opacity: 0.8;
        background-color: #f8f9fa;
    }
    
    /* Animation for completed goals */
    .goal-completed {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 128, 0, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 128, 0, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 128, 0, 0);
        }
    }
    
    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
    }
    
    .notification.fade-out {
        animation: fadeOut 0.5s ease-out forwards;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all update goal buttons
    const updateGoalButtons = document.querySelectorAll('.update-goal-btn');
    const updateGoalModal = new bootstrap.Modal(document.getElementById('updateGoalModal'));
    const updateGoalForm = document.getElementById('updateGoalForm');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    
    // Store the current goal ID being edited
    let currentGoalId = null;

    // Function to populate the form with current goal data
    function populateGoalForm(goalData) {
        document.getElementById('goal_type').value = goalData.goal_type;
        document.getElementById('target').value = goalData.target;
        document.getElementById('end_date').value = goalData.end_date;
        document.getElementById('progress').value = goalData.progress;
    }

    // Handle "Update Goal" button clicks
    updateGoalButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            currentGoalId = this.getAttribute('data-goal-id');
            
            // Fetch current goal data
            fetch(`/workouts/api/goal/${currentGoalId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched goal data:', data);
                    populateGoalForm(data);
                    updateGoalModal.show();
                })
                .catch(error => {
                    console.error('Error fetching goal data:', error);
                    showNotification('Error loading goal data. Please try again.', 'error');
                });
        });
    });

    // Handle form submission
    if (saveGoalBtn) {
        saveGoalBtn.addEventListener('click', function() {
            if (!currentGoalId) {
                showNotification('Error: No goal selected for update.', 'error');
                return;
            }
            
            const formData = new FormData(updateGoalForm);
            
            // Log the form data for debugging
            console.log('Sending form data:', Object.fromEntries(formData));
            
            fetch(`/workouts/api/goal/${currentGoalId}/update/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    // Find the goal item in the DOM
                    const goalItem = document.querySelector(`.goal-item[data-goal-id="${currentGoalId}"]`);
                    console.log('Found goal item:', goalItem);
                    
                    if (goalItem) {
                        // Update the progress bar
                        const progressBar = goalItem.querySelector('.progress-bar');
                        console.log('Found progress bar:', progressBar);
                        
                        if (progressBar) {
                            // Get current progress value
                            const currentProgress = parseInt(progressBar.getAttribute('aria-valuenow') || '0');
                            const newProgress = data.progress;
                            
                            console.log(`Updating progress from ${currentProgress} to ${newProgress}`);
                            
                            // Force a DOM update by removing and re-adding the progress bar
                            const progressContainer = progressBar.parentElement;
                            const newProgressBar = progressBar.cloneNode(true);
                            
                            // Update the new progress bar
                            newProgressBar.style.width = `${newProgress}%`;
                            newProgressBar.textContent = `${newProgress}%`;
                            newProgressBar.setAttribute('aria-valuenow', newProgress);
                            
                            // Update color based on progress level
                            if (newProgress < 30) {
                                newProgressBar.style.background = 'linear-gradient(45deg, #FF4500, #FF6347)';
                            } else if (newProgress < 70) {
                                newProgressBar.style.background = 'linear-gradient(45deg, #FFD700, #FF8C00)';
                            } else if (newProgress < 100) {
                                newProgressBar.style.background = 'linear-gradient(45deg, #32CD32, #228B22)';
                            } else {
                                newProgressBar.style.background = 'linear-gradient(45deg, #00FF00, #008000)';
                                
                                // Add completion effects
                                goalItem.classList.add('goal-completed');
                                
                                // Show completion badge if it exists
                                const completedBadge = goalItem.querySelector('.completed-badge');
                                if (completedBadge) {
                                    completedBadge.classList.remove('d-none');
                                }
                                
                                // Hide edit button
                                const updateBtn = goalItem.querySelector('.update-goal-btn');
                                if (updateBtn) {
                                    updateBtn.style.display = 'none';
                                }
                            }
                            
                            // Replace the old progress bar with the new one
                            progressContainer.replaceChild(newProgressBar, progressBar);
                        }
                        
                        // Update the goal type and target
                        const titleElement = goalItem.querySelector('.card-title');
                        if (titleElement) {
                            titleElement.textContent = data.goal_type_display;
                        }
                        
                        const targetText = goalItem.querySelector('.card-text');
                        if (targetText) {
                            targetText.textContent = `Target: ${data.target}`;
                        }
                    } else {
                        console.error('Goal item not found in DOM');
                    }
                    
                    // Close the modal
                    updateGoalModal.hide();
                    
                    // Show success message
                    showNotification('Goal updated successfully!', 'success');
                } else {
                    showNotification('Error updating goal: ' + (data.errors ? Object.values(data.errors).join(', ') : 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error updating goal:', error);
                showNotification('Error updating goal. Please try again.', 'error');
            });
        });
    }
    
    // Function to show notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification`;
        notification.textContent = message;
        
        // Add to the page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 3000);
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Handle delete goal button clicks
    document.querySelectorAll('.delete-goal-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this goal?')) {
                const goalId = this.getAttribute('data-goal-id');
                console.log('Deleting goal with ID:', goalId);
                
                fetch(`/workouts/api/goal/${goalId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Delete response:', data);
                    
                    if (data.success) {
                        // Find and remove the goal item from the DOM
                        const goalItem = document.querySelector(`.goal-item[data-goal-id="${goalId}"]`);
                        console.log('Found goal item to delete:', goalItem);
                        
                        if (goalItem) {
                            goalItem.remove();
                            showNotification('Goal deleted successfully!', 'success');
                            
                            // If no goals left, show the "No goals" message
                            if (document.querySelectorAll('.goal-item').length === 0) {
                                location.reload(); // Refresh to show "No goals" message
                            }
                        } else {
                            console.error('Goal item not found in DOM');
                            showNotification('Error: Goal item not found in DOM', 'error');
                        }
                    } else {
                        showNotification('Error deleting goal: ' + (data.errors ? Object.values(data.errors).join(', ') : 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting goal:', error);
                    showNotification('Error deleting goal. Please try again.', 'error');
                });
            }
        });
    });
    
    // Handle add new goals
    const addGoalModal = new bootstrap.Modal(document.getElementById('addGoalModal'));
    const goalsList = document.getElementById('goalsList');
    const addAnotherGoalBtn = document.getElementById('addAnotherGoalBtn');
    const saveNewGoalsBtn = document.getElementById('saveNewGoalsBtn');
    const addGoalBtn = document.getElementById('addGoalBtn');
    const goalsContainer = document.getElementById('goalsContainer');
    const noGoalsMessage = document.getElementById('noGoalsMessage');
    
    // Check if we've reached the goal limit
    function checkGoalLimit() {
        const currentGoals = document.querySelectorAll('.goal-item').length;
        const maxGoals = 3;
        
        if (currentGoals >= maxGoals) {
            addGoalBtn.disabled = true;
            addGoalBtn.innerHTML = '<i class="fas fa-ban"></i> Goal Limit Reached';
            addGoalBtn.title = 'You can only have 3 goals at a time';
            return true;
        } else {
            addGoalBtn.disabled = false;
            addGoalBtn.innerHTML = '<i class="fas fa-plus"></i> Add Goal';
            addGoalBtn.title = '';
            return false;
        }
    }
    
    // Check goal limit on page load
    checkGoalLimit();

    // Function to create a new goal form
    function createGoalForm(index) {
        return `
            <div class="goal-form mb-4 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Goal #${index}</h6>
                    <button type="button" class="btn btn-sm btn-danger remove-goal-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form class="goal-entry-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Goal Type</label>
                            <select class="form-select goal-type" name="goal_type" required>
                                <option value="weight_loss">Weight Loss</option>
                                <option value="muscle_gain">Muscle Gain</option>
                                <option value="endurance">Endurance</option>
                                <option value="flexibility">Flexibility</option>
                                <option value="general_fitness">General Fitness</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Target</label>
                            <input type="text" class="form-control goal-target" name="target" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control goal-end-date" name="end_date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Initial Progress (%)</label>
                            <input type="number" class="form-control goal-progress" name="progress" min="0" max="100" value="0" required>
                        </div>
                    </div>
                </form>
            </div>
        `;
    }

    // Add another goal form
    if (addAnotherGoalBtn) {
        addAnotherGoalBtn.addEventListener('click', function() {
            const currentForms = document.querySelectorAll('.goal-form').length;
            const currentGoals = document.querySelectorAll('.goal-item').length;
            const maxGoals = 3;
            
            // Check if adding another form would exceed the goal limit
            if (currentForms + currentGoals >= maxGoals) {
                showNotification(`You can only have ${maxGoals} goals at a time.`, 'warning');
                return;
            }
            
            const newIndex = currentForms + 1;
            goalsList.insertAdjacentHTML('beforeend', createGoalForm(newIndex));
        });
    }

    // Remove goal form
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-goal-btn')) {
            const goalForm = e.target.closest('.goal-form');
            goalForm.remove();
            // Update remaining goal numbers
            document.querySelectorAll('.goal-form').forEach((form, index) => {
                form.querySelector('h6').textContent = `Goal #${index + 1}`;
            });
        }
    });

    // Save all goals
    if (saveNewGoalsBtn) {
        saveNewGoalsBtn.addEventListener('click', function() {
            const goalForms = document.querySelectorAll('.goal-entry-form');
            if (goalForms.length === 0) {
                showNotification('No goals to save. Please add at least one goal.', 'warning');
                return;
            }
            
            // Check if adding these goals would exceed the limit
            const currentGoals = document.querySelectorAll('.goal-item').length;
            if (currentGoals + goalForms.length > 3) {
                showNotification('You can only have 3 goals at a time. Please remove some goals before adding more.', 'warning');
                return;
            }
            
            // Disable the save button to prevent multiple submissions
            saveNewGoalsBtn.disabled = true;
            saveNewGoalsBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            // Collect all goal data
            const goals = Array.from(goalForms).map(form => {
                const formData = new FormData();
                formData.append('goal_type', form.querySelector('.goal-type').value);
                formData.append('target', form.querySelector('.goal-target').value);
                formData.append('end_date', form.querySelector('.goal-end-date').value);
                formData.append('progress', form.querySelector('.goal-progress').value);
                return formData;
            });
            
            console.log('Saving goals:', goals.length);
            
            // Save each goal sequentially
            let savedCount = 0;
            let errorCount = 0;
            let savedGoalIds = [];
            
            const saveNextGoal = (index) => {
                if (index >= goals.length) {
                    // All goals processed
                    saveNewGoalsBtn.disabled = false;
                    saveNewGoalsBtn.innerHTML = 'Save All Goals';
                    
                    if (savedCount > 0) {
                        showNotification(`Successfully saved ${savedCount} goal(s)!`, 'success');
                        
                        // Instead of reloading, dynamically add the new goals to the page
                        if (savedGoalIds.length > 0) {
                            // Fetch the newly created goals
                            Promise.all(savedGoalIds.map(id => 
                                fetch(`/workouts/api/goal/${id}/`)
                                    .then(response => response.json())
                            ))
                            .then(goalsData => {
                                console.log('Fetched new goals:', goalsData);
                                
                                // Remove the "No goals" message if it exists
                                if (noGoalsMessage) {
                                    noGoalsMessage.remove();
                                }
                                
                                // Add each new goal to the page
                                goalsData.forEach(goal => {
                                    if (goal.success) {
                                        // Create a new goal item
                                        const goalItem = document.createElement('div');
                                        goalItem.className = 'goal-item mb-4';
                                        goalItem.setAttribute('data-goal-id', goal.id);
                                        
                                        // Set the progress bar color based on progress
                                        let progressColor = 'linear-gradient(45deg, #FFD700, #FF8C00)';
                                        if (goal.progress < 30) {
                                            progressColor = 'linear-gradient(45deg, #FF4500, #FF6347)';
                                        } else if (goal.progress < 70) {
                                            progressColor = 'linear-gradient(45deg, #FFD700, #FF8C00)';
                                        } else if (goal.progress < 100) {
                                            progressColor = 'linear-gradient(45deg, #32CD32, #228B22)';
                                        } else {
                                            progressColor = 'linear-gradient(45deg, #00FF00, #008000)';
                                        }
                                        
                                        // Create the goal HTML
                                        goalItem.innerHTML = `
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title mb-0">${goal.goal_type_display}</h5>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-custom-gradient update-goal-btn" data-goal-id="${goal.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-goal-btn" data-goal-id="${goal.id}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="card-text">Target: ${goal.target}</p>
                                            <div class="progress mb-3">
                                                <div class="progress-bar" 
                                                    role="progressbar" 
                                                    style="width: ${goal.progress}%; background: ${progressColor};" 
                                                    aria-valuenow="${goal.progress}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                    ${goal.progress}%
                                                </div>
                                            </div>
                                            ${goal.end_date ? `<p class="card-text"><small class="text-muted">End Date: ${new Date(goal.end_date).toLocaleDateString()}</small></p>` : ''}
                                        `;
                                        
                                        // Add the new goal to the page
                                        goalsContainer.appendChild(goalItem);
                                        
                                        // Add event listeners to the new buttons
                                        const updateBtn = goalItem.querySelector('.update-goal-btn');
                                        if (updateBtn) {
                                            updateBtn.addEventListener('click', function(event) {
                                                event.preventDefault();
                                                currentGoalId = this.getAttribute('data-goal-id');
                                                
                                                // Fetch current goal data
                                                fetch(`/workouts/api/goal/${currentGoalId}/`)
                                                    .then(response => {
                                                        if (!response.ok) {
                                                            throw new Error(`HTTP error! Status: ${response.status}`);
                                                        }
                                                        return response.json();
                                                    })
                                                    .then(data => {
                                                        console.log('Fetched goal data:', data);
                                                        populateGoalForm(data);
                                                        updateGoalModal.show();
                                                    })
                                                    .catch(error => {
                                                        console.error('Error fetching goal data:', error);
                                                        showNotification('Error loading goal data. Please try again.', 'error');
                                                    });
                                            });
                                        }
                                        
                                        const deleteBtn = goalItem.querySelector('.delete-goal-btn');
                                        if (deleteBtn) {
                                            deleteBtn.addEventListener('click', function() {
                                                if (confirm('Are you sure you want to delete this goal?')) {
                                                    const goalId = this.getAttribute('data-goal-id');
                                                    console.log('Deleting goal with ID:', goalId);
                                                    
                                                    fetch(`/workouts/api/goal/${goalId}/delete/`, {
                                                        method: 'POST',
                                                        headers: {
                                                            'X-CSRFToken': getCookie('csrftoken')
                                                        }
                                                    })
                                                    .then(response => {
                                                        if (!response.ok) {
                                                            throw new Error(`HTTP error! Status: ${response.status}`);
                                                        }
                                                        return response.json();
                                                    })
                                                    .then(data => {
                                                        console.log('Delete response:', data);
                                                        
                                                        if (data.success) {
                                                            goalItem.remove();
                                                            showNotification('Goal deleted successfully!', 'success');
                                                            
                                                            // If no goals left, show the "No goals" message
                                                            if (document.querySelectorAll('.goal-item').length === 0) {
                                                                const noGoalsMsg = document.createElement('p');
                                                                noGoalsMsg.className = 'card-text';
                                                                noGoalsMsg.id = 'noGoalsMessage';
                                                                noGoalsMsg.textContent = 'No goals set yet.';
                                                                goalsContainer.appendChild(noGoalsMsg);
                                                            }
                                                            
                                                            // Check if we need to enable the add goal button
                                                            checkGoalLimit();
                                                        } else {
                                                            showNotification('Error deleting goal: ' + (data.errors ? Object.values(data.errors).join(', ') : 'Unknown error'), 'error');
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error('Error deleting goal:', error);
                                                        showNotification('Error deleting goal. Please try again.', 'error');
                                                    });
                                                }
                                            });
                                        }
                                    }
                                });
                                
                                // Close the modal
                                addGoalModal.hide();
                                
                                // Reset the form
                                goalsList.innerHTML = createGoalForm(1);
                                
                                // Check if we need to disable the add goal button
                                checkGoalLimit();
                            })
                            .catch(error => {
                                console.error('Error fetching new goals:', error);
                                // If there's an error fetching the new goals, just reload the page
                                location.reload();
                            });
                        } else {
                            // If no goals were saved, just reload the page
                            location.reload();
                        }
                    } else if (errorCount > 0) {
                        showNotification(`Failed to save any goals. Please try again.`, 'error');
                    }
                    return;
                }
                
                fetch('/workouts/api/goal/add/', {
                    method: 'POST',
                    body: goals[index],
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Goal saved:', data);
                    if (data.success) {
                        savedCount++;
                        // Store the ID of the saved goal
                        if (data.id) {
                            savedGoalIds.push(data.id);
                        }
                    } else {
                        errorCount++;
                        console.error('Error saving goal:', data.errors);
                    }
                    saveNextGoal(index + 1);
                })
                .catch(error => {
                    console.error('Error saving goal:', error);
                    errorCount++;
                    saveNextGoal(index + 1);
                });
            };
            
            // Start saving goals
            saveNextGoal(0);
        });
    }

    // Initialize workout confirmation modal
    const workoutModal = new bootstrap.Modal(document.getElementById('workoutConfirmationModal'));
    let currentWorkout = null;

    // Add click event listeners to all start workout buttons
    document.querySelectorAll('.start-workout-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentWorkout = {
                name: this.dataset.workoutName,
                description: this.dataset.workoutDescription,
                duration: this.dataset.workoutDuration,
                calories: this.dataset.workoutCalories,
                notes: this.dataset.workoutNotes
            };

            // Update modal content
            document.getElementById('modal-workout-name').textContent = currentWorkout.name;
            document.getElementById('modal-workout-duration').textContent = currentWorkout.duration;
            document.getElementById('modal-workout-calories').textContent = currentWorkout.calories;

            // Show the modal
            workoutModal.show();
        });
    });

    // Handle workout confirmation
    document.getElementById('confirmWorkoutBtn').addEventListener('click', function() {
        if (currentWorkout) {
            // Create FormData object
            const formData = new FormData();
            formData.append('name', currentWorkout.name);
            formData.append('description', currentWorkout.description);
            formData.append('duration', currentWorkout.duration);
            formData.append('calories_burned', currentWorkout.calories);
            formData.append('notes', currentWorkout.notes || '');
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

            // Send workout data to server
            fetch('/workouts/log/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(() => {
                // Show success notification
                showNotification('Workout logged successfully!', 'success');
                // Hide the modal
                workoutModal.hide();
                // Reload the page to update the history
                setTimeout(() => window.location.reload(), 1500);
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error logging workout. Please try again.', 'error');
            });
        }
    });
});
</script>
{% endblock content %}